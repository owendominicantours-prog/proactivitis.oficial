generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VehicleCategory {
  SEDAN
  VAN
  SUV
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AgencyProfile {
  id          String  @id
  userId      String  @unique
  companyName String
  approved    Boolean @default(false)
  User        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Booking {
  id                    String         @id @default(cuid())
  tourId                String
  userId                String
  status                String         @default("CONFIRMED")
  source                String         @default("WEB")
  customerName          String
  customerEmail         String
  customerPhone         String?
  bookingCode           String?        @unique
  travelDate            DateTime       @map("date")
  paxAdults             Int            @default(1)
  paxChildren           Int            @default(0)
  passengers            Int?
  pickup                String?
  hotel                 String?
  originAirport         String?
  pickupNotes           String?
  totalAmount           Float
  stripeSessionId       String?        @map("stripe_session_id")
  stripePaymentIntentId String?        @map("stripe_payment_intent_id")
  stripeCheckoutUrl     String?        @map("stripe_checkout_url")
  paymentStatus         String?        @map("payment_status")
  supplierAmount        Float?
  platformFee           Float?
  agencyFee             Float?
  startTime             String?
  flightNumber          String?
  flowType              String?        @default("tour")
  cancellationReason    String?
  cancellationByRole    String?
  cancellationAt        DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime?      @updatedAt
  User                  User           @relation(fields: [userId], references: [id])
  Tour                  Tour           @relation(fields: [tourId], references: [id])
  AgencyProLink         AgencyProLink? @relation("AgencyProBookings", fields: [agencyProLinkId], references: [id])
  agencyProLinkId       String?
  agencyMarkupAmount    Float?
  agencyPricingMode     Boolean        @default(false)
  Conversation          Conversation?
  paymentBrand          String?        @map("payment_brand")
  paymentLast4          String?        @map("payment_last4")
  paymentMethod         String?        @map("payment_method")
}

model Conversation {
  id                      String                    @id
  type                    String                    @default("SUPPORT")
  reservationId           String?                   @unique
  createdById             String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  User                    User                      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  Booking                 Booking?                  @relation(fields: [reservationId], references: [id])
  ConversationParticipant ConversationParticipant[]
  Message                 Message[]
}

model ConversationParticipant {
  conversationId String
  userId         String
  role           String?      @default("MEMBER")
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
}

model LandingPage {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  body      String
  updatedAt DateTime @default(now()) @updatedAt
}

model Message {
  id             String       @id
  conversationId String
  senderId       String
  senderRole     String
  content        String
  createdAt      DateTime     @default(now())
  User           User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  Conversation   Conversation @relation(fields: [conversationId], references: [id])
}

model Notification {
  id         String   @id
  type       String?
  role       String?
  title      String
  message    String?
  body       String?
  bookingId  String?
  metadata   String?
  caseNumber String?
  isRead     Boolean  @default(false) @map("read")
  createdAt  DateTime @default(now())
}

model PartnerApplication {
  id           String   @id @default(cuid())
  role         String
  companyName  String
  contactName  String
  contactRole  String
  email        String
  phone        String
  country      String
  website      String?
  serviceTypes String
  description  String
  documentName String?
  documentUrl  String?
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String?
  User         User?    @relation(fields: [userId], references: [id])
}

model Offer {
  id          String   @id @default(cuid())
  tourId      String
  title       String
  description String
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  Tour        Tour     @relation(fields: [tourId], references: [id])
}

/// Fase 1: definición de países/destinos públicos para catálogo. Las relaciones y migraciones se aplicarán después.
model Country {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  code             String        @unique
  shortDescription String?
  heroImage        String?
  destinations     Destination[]
  locations        Location[]    @relation("CountryLocations")
  tours            Tour[]        @relation("CountryTours")
  microZones       MicroZone[]   @relation("CountryMicroZones")
  transferZones    TransferZone[]
  transferRates    TransferRate[]
}

model Destination {
  id               String      @id @default(cuid())
  name             String
  slug             String      @unique
  shortDescription String?
  heroImage        String?
  country          Country     @relation(fields: [countryId], references: [id])
  countryId        String
  tours            Tour[]      @relation("TourDestination")
  departureTours   Tour[]      @relation("TourDepartureDestination")
  microZones       MicroZone[] @relation("DestinationMicroZones")
  locations        Location[]  @relation("LocationDestination")
}

model MicroZone {
  id            String      @id @default(cuid())
  name          String
  slug          String      @unique
  destination   Destination @relation("DestinationMicroZones", fields: [destinationId], references: [id])
  destinationId String
  country       Country     @relation("CountryMicroZones", fields: [countryCode], references: [code])
  countryCode   String
  locations     Location[]  @relation("MicroZoneLocations")
  tours         Tour[]      @relation("TourMicroZone")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Location {
  id            String       @id @default(cuid())
  name          String
  slug          String       @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  country       Country      @relation("CountryLocations", fields: [countryId], references: [code])
  countryId     String       @default("RD")
  destination   Destination? @relation("LocationDestination", fields: [destinationId], references: [id])
  destinationId String?
  microZone     MicroZone?   @relation("MicroZoneLocations", fields: [microZoneId], references: [id])
  microZoneId   String?
}

model TransferZone {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  countryCode String
  description String?
  meta        Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  country     Country     @relation(fields: [countryCode], references: [code])
  originRates TransferRate[] @relation("OriginRates")
  destinationRates TransferRate[] @relation("DestinationRates")
}

model TransferRate {
  id                 String          @id @default(cuid())
  originZoneId       String
  destinationZoneId  String
  countryCode        String
  vehicleCategory    VehicleCategory
  price              Float
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  originZone         TransferZone    @relation("OriginRates", fields: [originZoneId], references: [id])
  destinationZone    TransferZone    @relation("DestinationRates", fields: [destinationZoneId], references: [id])
  country            Country         @relation(fields: [countryCode], references: [code])

  @@unique([originZoneId, destinationZoneId, vehicleCategory])
  @@index([countryCode])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SupplierProfile {
  id              String      @id
  userId          String      @unique
  company         String
  approved        Boolean     @default(false)
  stripeAccountId String?     @map("stripe_account_id")
  User            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Tour            Tour[]
  drafts          TourDraft[]
}

model TourDraft {
  id         String          @id @default(cuid())
  supplierId String
  draftKey   String
  title      String?
  data       Json
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  Supplier   SupplierProfile @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, draftKey])
}

model AgencyProLink {
  id           String    @id @default(cuid())
  slug         String    @unique
  tourId       String
  agencyUserId String
  price        Float
  basePrice    Float
  markup       Float
  note         String?
  active       Boolean   @default(true)
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Tour         Tour      @relation(fields: [tourId], references: [id])
  AgencyUser   User      @relation(fields: [agencyUserId], references: [id])
  Booking      Booking[] @relation("AgencyProBookings")
}

model Tour {
  id                     String          @id
  title                  String
  slug                   String          @unique
  productId              String          @unique @default(uuid())
  price                  Float
  priceChild             Float?
  priceYouth             Float?
  duration               String
  description            String          @db.Text
  subtitle               String?
  shortDescription       String?         @db.Text
  category               String?
  physicalLevel          String?
  minAge                 Int?
  accessibility          String?
  confirmationType       String?
  timeOptions            String?
  operatingDays          String?
  blackoutDates          String?
  capacity               Int?
  meetingPoint           String?
  meetingInstructions    String?
  pickup                 String?
  requirements           String?
  cancellationPolicy     String?
  terms                  String?
  language               String
  includes               String
  location               String
  supplierId             String
  featured               Boolean         @default(false)
  status                 String          @default("draft")
  adminNote              String?
  createdAt              DateTime        @default(now())
  gallery                String?
  heroImage              String?
  departureDestinationId String?
  departureDestination   Destination?    @relation("TourDepartureDestination", fields: [departureDestinationId], references: [id])
  Booking                Booking[]
  Offer                  Offer[]
  platformSharePercent   Int             @default(20)
  SupplierProfile        SupplierProfile @relation(fields: [supplierId], references: [id])
  AgencyProLinks         AgencyProLink[]
  country                Country         @relation("CountryTours", fields: [countryId], references: [code])
  countryId              String          @default("RD")
  destination            Destination?    @relation("TourDestination", fields: [destinationId], references: [id])
  destinationId          String?
  microZone              MicroZone?      @relation("TourMicroZone", fields: [microZoneId], references: [id])
  microZoneId            String?
}

model User {
  id                      String                    @id @default(cuid())
  name                    String?
  email                   String                    @unique
  password                String?
  role                    String                    @default("CUSTOMER")
  supplierApproved        Boolean                   @default(false)
  agencyApproved          Boolean                   @default(false)
  accountStatus           String                    @default("PENDING")
  statusMessage           String?
  rejectionAt             DateTime?
  createdAt               DateTime                  @default(now())
  Account                 Account[]
  AgencyProfile           AgencyProfile?
  Booking                 Booking[]
  Conversation            Conversation[]
  ConversationParticipant ConversationParticipant[]
  Message                 Message[]
  Session                 Session[]
  SupplierProfile         SupplierProfile?
  PartnerApplication      PartnerApplication[]
  CustomerPayment         CustomerPayment?
  AgencyProLinks          AgencyProLink[]
}

model CustomerPayment {
  id        String   @id @default(cuid())
  userId    String   @unique
  method    String?
  brand     String?
  last4     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
